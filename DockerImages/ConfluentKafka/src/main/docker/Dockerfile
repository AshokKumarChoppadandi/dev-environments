FROM centos:7

LABEL maintainer="Ashok Kumar Choppadandi <ashokkumar98778@gmail.com>"

USER root

WORKDIR /

ARG CONFLUENT_KAFKA_DOWNLOAD_URL=https://packages.confluent.io/archive/5.5/confluent-community-5.5.3-2.12.tar.gz?_ga=2.198249062.812666055.1638263298-1897962138.1637336693

ENV CONFLUENT_HOME /usr/local/confluent

RUN yum update -y \
    && yum install java-1.8.0-openjdk-devel wget -y \
    && curl -L $CONFLUENT_KAFKA_DOWNLOAD_URL -o confluent-community.tar.gz \
    && tar -xzvf confluent-community*.tar.gz* -C /usr/local/ \
    && ln -s /usr/local/confluent* $CONFLUENT_HOME \
    && rm -rf confluent-community*.tar.gz*

COPY ./configs /usr/local/configs

ENV JAVA_HOME "/usr/lib/jvm/java"
ENV PATH $CONFLUENT_HOME/bin:$JAVA_HOME/bin:$PATH

# ZOOKEEPER PROPERTIES
ENV ZOOKEEPER_DATA_DIR "\/tmp\/zookeeper"
ENV ZOOKEEPER_CLIENT_PORT 2181
ENV ZOOKEEPER_MAX_CLIENT_CONNECTIONS 0
ENV ZOOKEEPER_TICK_TIME 2000
ENV ZOOKEEPER_ENABLE_SERVER false
ENV ZOOKEEPER_ADMIN_SERVER_PORT 8080
ENV ZOOKEEPER_QUORUM "zookeeper1,zookeeper2,zookeeper3"
ENV ZOOKEEPER_ID 1
ENV ZOOKEEPER_INIT_LIMIT 5
ENV ZOOKEEPER_SYNC_LIMIT 2

# KAFKA BROKER PROPERTIES
ENV BROKER_ID 0
ENV KAFKA_LISTENERS "PLAINTEXT:\/\/0.0.0.0:9092"
ENV KAFKA_ADVERTISED_LISTENERS "PLAINTEXT:\/\/localhost:9092"
ENV NUM_NETWORK_THREADS 3
ENV NUM_IO_THREADS 8
ENV SOCKET_SEND_BUFFER_BYTES 102400
ENV SOCKET_RECEIVE_BUFFER_BYTES 102400
ENV SOCKET_REQUEST_MAX_BYTES 104857600
ENV LOG_DIRS "\/tmp\/kafka-logs"
ENV NUM_PARTITIONS 1
ENV NUM_RECOVERY_THREADS_PER_DATA_DIR 1
ENV OFFSETS_TOPIC_REPLICATION_FACTOR 1
ENV TRANSACTION_STATE_LOG_REPLICATION_FACTOR 1
ENV TRANSACTION_STATE_LOG_MIN_ISR 1
ENV LOG_RETENTION_HOURS 168
ENV LOG_SEGMENT_BYTES 1073741824
ENV LOG_RETENTION_CHECK_INTERVAL_MS 300000
ENV ZOOKEEPER_CONNECT_LIST localhost:2181
ENV ZOOKEEPER_CONNECTION_TIMEOUT_MS 18000
ENV GROUP_INITIAL_REBALANCE_DELAY_MS 0

# KAFKA CONNECT PROPERTIES
ENV CONNECT_WITH_AVRO_DISTRIBUTED true
ENV BOOTSTRAP_SERVERS localhost:9092
ENV GROUP_ID connect-cluster
ENV KEY_CONVERTER io.confluent.connect.avro.AvroConverter
ENV KEY_CONVERTER_SCHEMA_REGISTRY_URL "http:\/\/localhost:8081"
ENV VALUE_CONVERTER io.confluent.connect.avro.AvroConverter
ENV VALUE_CONVERTER_SCHEMA_REGISTRY_URL "http:\/\/localhost:8081"
ENV KEY_CONVERTER_SCHEMAS_ENABLE true
ENV VALUE_CONVERTER_SCHEMAS_ENABLE true
ENV OFFSET_STORAGE_TOPIC connect-offsets
ENV OFFSET_STORAGE_REPLICATION_FACTOR 1
ENV OFFSET_STORAGE_PARTITIONS 25
ENV CONFIG_STORAGE_TOPIC connect-configs
ENV CONFIG_STORAGE_REPLICATION_FACTOR 1
ENV STATUS_STORAGE_TOPIC connect-status
ENV STATUS_STORAGE_REPLICATION_FACTOR 1
ENV STATUS_STORAGE_PARTITIONS 5
ENV OFFSET_FLUSH_INTERVAL_MS 10000
ENV CONNECT_REST_HOST 0.0.0.0
ENV CONNECT_REST_PORT 8083
ENV CONNECT_REST_ADVERTISED_HOST localhost
ENV CONNECT_REST_ADVERTISED_PORT 8083
ENV PLUGIN_PATH "\/usr\/local\/confluent\/share\/java\/"

# SCHEMA REGISTRY PROPERTIES
ENV SCHEMA_REGISTRY_LISTENERS "http:\/\/0.0.0.0:8081"
ENV KAFKASTORE_BOOTSTRAP_SERVERS localhost:9092
ENV KAFKASTORE_TOPIC _schemas
ENV DEBUG false

# KSQLDB PROPERTIES
ENV KSQL_DB_LISTENERS "http:\/\/0.0.0.0:8088"
ENV KSQL_LOGGING_PROCESSING_TOPIC_AUTO_CREATE true
ENV KSQL_LOGGING_PROCESSING_STREAM_AUTO_CREATE true
ENV KSQL_LOGGING_PROCESSING_ROWS_INCLUDE true
ENV KSQL_SCHEMA_REGISTRY_URL "http:\/\/localhost:8081"
ENV UI_ENABLED true
ENV KSQL_STREAMS_AUTO_OFFSET_RESET latest
ENV KSQL_STREAMS_COMMIT_INTERVAL_MS 2000
ENV KSQL_STREAMS_CACHE_MAX_BYTES_BUFFERING 10000000
ENV KSQL_FAIL_ON_DESERIALIZATION_ERROR true
ENV KSQL_STREAMS_NUM_STREAM_THREADS 1
ENV KSQL_SERVICE_ID default_
ENV KSQL_SINK_PARTITIONS 4
ENV KSQL_SINK_REPLICAS 1

COPY ./confluent-kafka-docker-entrypoint.sh /
RUN chmod +x /confluent-kafka-docker-entrypoint.sh

ENTRYPOINT ["./confluent-kafka-docker-entrypoint.sh"]
CMD ["sh"]